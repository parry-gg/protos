// Tournament bracket system definitions for single and double elimination.
// Manages match progression, seeding, and bracket state tracking.
syntax = "proto3";

option java_multiple_files = true;
option java_package = "gg.parry.grpc.models";

package parrygg.models;

import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";
import "models/entrant.proto";
import "models/progression.proto";
import "models/hierarchy.proto";
import "models/game.proto";

// BracketType defines the format for the bracket.
enum BracketType {
  // Default unspecified type.
  BRACKET_TYPE_UNSPECIFIED = 0;
  // Single elimination - one loss eliminates the participant.
  BRACKET_TYPE_SINGLE_ELIMINATION = 1;
  // Double elimination - participants get a second chance in losers bracket.
  BRACKET_TYPE_DOUBLE_ELIMINATION = 2;
  // Round robin - participants play all other participants at once.
  BRACKET_TYPE_ROUND_ROBIN = 3;
}

// BracketState represents the current status of bracket execution.
enum BracketState {
  // Default unspecified state.
  BRACKET_STATE_UNSPECIFIED = 0;
  // Bracket created but not yet ready for matches.
  BRACKET_STATE_PENDING = 1;
  // Bracket is seeded and ready for competition.
  BRACKET_STATE_READY = 2;
  // Matches are currently being played.
  BRACKET_STATE_IN_PROGRESS = 3;
  // All matches completed with final results.
  BRACKET_STATE_COMPLETED = 4;
}

// Bracket represents a tournament bracket containing matches and seeding.
// Next id: 13
message Bracket {
  // Unique identifier for the bracket (UUID v7).
  string id = 1;
  // Current execution state of the bracket.
  BracketState state = 2;
  // All matches within this bracket.
  repeated Match matches = 3;
  // Rules for advancing between brackets/phases.
  repeated Progression progressions = 4;
  // Ordering index within the parent phase.
  int32 index = 5;
  // Seeded positions for participants.
  repeated Seed seeds = 6;
  // Last modification timestamp.
  google.protobuf.Timestamp updated_at = 7;
  // Display name for the bracket.
  string name = 8;
  // URL-friendly identifier.
  string slug = 9;
  // Hash for detecting bracket modifications.
  string checksum = 10;
  // Bracket type.
  BracketType type = 11;
  // Seeds in future phases which progressed from this bracket.
  repeated Seed progressed_seeds = 12;
}


// MatchState tracks the progress of individual matches.
enum MatchState {
  // Default unspecified state.
  MATCH_STATE_UNSPECIFIED = 0;
  // Match created but waiting for participants.
  MATCH_STATE_PENDING = 1;
  // Both participants assigned and ready to play.
  MATCH_STATE_READY = 2;
  // Match is currently being played.
  MATCH_STATE_IN_PROGRESS = 3;
  // Match completed with final score.
  MATCH_STATE_COMPLETED = 4;
}

// MatchGameState tracks the progress of individual games within a match.
enum MatchGameState {
  // Default unspecified state.
  MATCH_GAME_STATE_UNSPECIFIED = 0;
  // Game has not yet begun.
  MATCH_GAME_STATE_PENDING = 1;
  // Game is currently being played.
  MATCH_GAME_STATE_IN_PROGRESS = 2;
  // Game completed with final score.
  MATCH_GAME_STATE_COMPLETED = 3;
}

// Match represents an individual game between participants in a bracket.
// Contains participant slots, scoring, and progression information.
// Next id: 20
message Match {
  // Unique identifier for the match (UUID v7).
  string id = 1;
  // Human-readable match identifier (e.g., "A", "B", "ZZ").
  string identifier = 2;
  // Round number within the bracket (1-indexed).
  int32 round = 5;
  // Whether this match is on the winners side (true) or losers side (false).
  bool winners_side = 6;
  // Whether this is the grand finals match.
  bool grand_finals = 7;
  // ID of the first preceding match that feeds into this match.
  optional string prev_match_id_1 = 8;
  // ID of the second preceding match that feeds into this match.
  optional string prev_match_id_2 = 9;
  // ID of the match where the winner advances.
  optional string winners_match_id = 10;
  // ID of the match where the loser advances (double elimination).
  optional string losers_match_id = 11;
  // Current state of the match.
  MatchState state = 12;
  // Participant slots with scores and placement.
  repeated Slot slots = 13;
  // When the match state was last updated.
  google.protobuf.Timestamp state_updated_at = 14;
  // Individual games within this match.
  repeated MatchGame match_games = 15;
  // The minimum placement the winner of this match is guaranteed in the event.
  int32 winners_placement = 16;
  // The minimum placement the loser of this match is guaranteed in the event.
  int32 losers_placement = 17;
  // When the match was marked as started.
  google.protobuf.Timestamp started_at = 18;
  // When the match was marked as completed.
  google.protobuf.Timestamp ended_at = 19;
}

// MatchGame represents an individual game within a match set.
// Contains stage selection and slots for per-game scoring.
// Next id: 8
message MatchGame {
  // Unique identifier for the match game (UUID v7).
  string id = 1;
  // Ordering index within the parent match (0-indexed).
  int32 index = 2;
  // Stages played in this game.
  repeated Stage stages = 3;
  // Per-game slots with scoring and participant details.
  repeated MatchGameSlot slots = 4;
  // Current state of this game.
  MatchGameState state = 5;
  // Time this game started.
  google.protobuf.Timestamp started_at = 6;
  // Time this game was completed.
  google.protobuf.Timestamp ended_at = 7;
}

// GameSlot represents a participant's performance in a single game.
// Contains per-game scoring, state, and user participation details.
// Next id: 7
message MatchGameSlot {
  // Unique identifier for the game slot (UUID v7).
  string id = 1;
  // The slot number within the match (0-indexed).
  int32 slot = 2;
  // The participant's score in this specific game.
  double score = 3;
  // Current state of this slot in this game.
  optional SlotState state = 4;
  // Users participating in this slot for this game.
  repeated MatchGameParticipant participants = 5;
  // The participant's placement in this specific game.
  int32 placement = 6;
}

// GameParticipant represents a user's participation in a game slot.
// Contains character selections for team-based games.
// Next id: 4
message MatchGameParticipant {
  // Unique identifier for the game participant (UUID v7).
  string id = 1;
  // ID of the user participating.
  string user_id = 2;
  // Characters used by this user in this game.
  repeated Character characters = 3;
}

// MatchResult contains the scoring updates for a completed match.
message MatchResult {
    // Score and state updates for each participant slot.
    repeated MatchResultSlotMutation slots = 1;
}

// MatchResultSlotMutation updates scoring and state for a single participant slot.
message MatchResultSlotMutation {
  // The slot number being updated (0-indexed).
  int32 slot = 1;
  // The participant's score in the match.
  optional double score = 2;
  // The participant's final state (completed, DQ, etc.).
  optional SlotState state = 3;
}

// SlotState represents the current status of a participant slot in a match.
enum SlotState {
  // Default unspecified state.
  SLOT_STATE_UNSPECIFIED = 0;
  // Slot is waiting for a participant or match to start.
  SLOT_STATE_PENDING = 1;
  // Slot has a numeric score and normal completion.
  SLOT_STATE_NUMERIC = 2;
  // Participant was disqualified from this slot.
  SLOT_STATE_DQ = 3;
  // Slot received a bye (no opponent, automatic advance).
  SLOT_STATE_BYE = 4;
}

// Slot represents a participant position within a match.
// Contains the participant, their score, and final placement.
// Next id: 6
message Slot {
  // The slot number within the match (0-indexed).
  int32 slot = 1;
  // ID of the seed that occupies this slot.
  string seed_id = 2;
  // Final placement of this participant in the match (1st, 2nd, etc.).
  int32 placement = 3;
  // The participant's score in this match.
  double score = 4;
  // Current state of this slot.
  SlotState state = 5;
}

// Seed represents a seeded position in a tournament bracket.
// Links a participant to their initial bracket position.
// Next id: 6
message Seed {
  // Unique identifier for the seed (UUID v7).
  string id = 1;
  // Seed number indicating bracket position (1 = top seed).
  int32 seed = 2;
  // The participant assigned to this seed.
  EventEntrant event_entrant = 3;
  // The index of this seed's bracket within its phase
  int32 bracket_index = 4;
  // The progression which assigns an entrant to this seed in a multiphase bracket.
  Progression progression = 5;
  // The participant who is projected to occupy this seed, if it hasn't yet been filled.
  EventEntrant projected_event_entrant = 6;
}

// SeedMutation updates the seed number of an existing seed.
message SeedMutation {
  // Updated seed number for bracket positioning.
  optional int32 seed = 2;
  // Whether the update should only affect seeds in the specified seed's current bracket.
  optional bool bracket_only = 3;
}

// MatchGameMutation updates an existing match game or creates a new one.
// Contains only updatable fields - no id or read-only data.
// Next id: 5
message MatchGameMutation {
  // Index for ordering within the match (0-indexed). Required.
  int32 index = 1;
  // Stages selected for this game with optional variant metadata.
  repeated StageSelection stages = 2;
  // Per-game slot data with scores and participant details.
  repeated GameSlotMutation slots = 3;
  // State for this game.
  MatchGameState state = 4;
}

// StageSelection specifies a stage played with optional variant data.
// Next id: 3
message StageSelection {
  // Slug of the stage (e.g., "final-destination", "battlefield").
  string stage_slug = 1;
  // Optional variant metadata (e.g., {"form": "battlefield", "hazards": "off"}).
  // Stored as JSONB, merged into stages array.
  optional google.protobuf.Struct variant = 2;
}

// GameSlotMutation updates a slot within a match game.
// Next id: 6
message GameSlotMutation {
  // The slot number (0-indexed, must correspond to parent match slot).
  int32 slot = 1;
  // Per-game score for this slot.
  optional double score = 2;
  // Per-game state for this slot.
  optional SlotState state = 3;
  // Participant data including character selections.
  repeated GameParticipantMutation participants = 4;
  // The participant's placement in this specific game.
  optional int32 placement = 5;
}

// GameParticipantMutation updates a user's participation in a game slot.
// Next id: 3
message GameParticipantMutation {
  // ID of the user participating in this game.
  // Must be a member of the entrant assigned to this match slot.
  string user_id = 1;
  // Characters selected by this user with optional variant metadata.
  repeated CharacterSelection characters = 2;
}

// CharacterSelection specifies a character used with optional variant data.
// Next id: 3
message CharacterSelection {
  // Slug of the character (e.g., "mario", "fox", "ken").
  string character_slug = 1;
  // Optional variant metadata (e.g., {"color": 2, "costume": "alt"}).
  // Stored as JSONB, merged into characters array.
  optional google.protobuf.Struct variant = 2;
}

// BracketSlugId provides slug-based identification for brackets.
// Uses hierarchical tournament/event/phase/bracket structure.
message BracketSlugId {
  // URL slug of the parent tournament.
  string tournament_slug = 1;
  // URL slug of the parent event.
  string event_slug = 2;
  // URL slug of the parent phase.
  string phase_slug = 3;
  // URL slug of the bracket.
  string bracket_slug = 4;
}

// MatchContext provides a match with tournament and bracket metadata for UI display.
message MatchContext {
  // The match information.
  Match match = 1;
  // Tournament hierarchy path (tournament/event/phase/bracket).
  parrygg.models.Hierarchy hierarchy = 2;
  // Event start time.
  google.protobuf.Timestamp event_start_date = 3;
  // Bracket progress (0.0 to 1.0, representing percentage of completed matches).
  float bracket_progress = 4;
  // Seeds with entrant information for all participants in this match.
  repeated Seed seeds = 5;
  // The game being played in this match (e.g., Street Fighter, Smash Bros).
  Game game = 6;
}
